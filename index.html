<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Gestão - Júlia Ribeiro</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Chart.js para Gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Font Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.2s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .slide-up { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .bg-julia { background-color: #940969; }
        .text-julia { color: #940969; }
        
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.98); z-index: 9999;
            display: flex; justify-content: center; align-items: center;
            flex-direction: column; text-align: center; padding: 20px;
        }

        .error-box {
            background: #fff1f2; border: 1px solid #f43f5e; color: #9f1239;
            padding: 1.5rem; border-radius: 0.75rem; max-width: 500px;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 h-screen flex overflow-hidden">

    <!-- LOADING OVERLAY -->
    <div id="loading-overlay">
        <div id="loader-spinner" class="animate-spin rounded-full h-12 w-12 border-b-2 border-[#940969]"></div>
        <p id="loader-text" class="mt-4 text-[#940969] font-medium animate-pulse">Estabelecendo conexão segura...</p>
        <p id="loader-subtext" class="text-xs text-gray-400 mt-2">Isso pode levar alguns segundos na primeira conexão.</p>
        <div id="error-container" class="hidden fade-in"></div>
    </div>

    <!-- SIDEBAR -->
    <aside class="w-64 bg-white border-r border-gray-200 hidden md:flex flex-col flex-shrink-0">
        <div class="p-6 flex items-center gap-3 border-b border-gray-100">
            <div class="w-8 h-8 bg-[#940969] rounded-lg flex items-center justify-center shadow-sm">
                <i data-lucide="layout-dashboard" class="text-white w-5 h-5"></i>
            </div>
            <span class="font-bold text-lg text-gray-800 tracking-tight">Júlia Ribeiro</span>
        </div>

        <nav class="flex-1 p-4 space-y-2">
            <button onclick="switchTab('dashboard')" id="btn-dashboard" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium transition-colors bg-[#940969]/10 text-[#940969] shadow-sm">
                <i data-lucide="pie-chart" class="w-5 h-5"></i>
                Painel Geral
            </button>
            <button onclick="switchTab('list')" id="btn-list" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium transition-colors text-gray-600 hover:bg-gray-50">
                <i data-lucide="list-todo" class="w-5 h-5"></i>
                Lista de Tarefas
            </button>
        </nav>

        <div class="p-4 border-t border-gray-100">
            <div class="bg-gradient-to-br from-pink-50 to-purple-50 p-4 rounded-xl border border-pink-100" id="statusBox">
                <h4 class="font-semibold text-[#940969] text-sm mb-1">Status Firebase</h4>
                <div class="flex items-center gap-2 mt-2">
                    <span id="statusDot" class="w-2 h-2 bg-gray-400 rounded-full"></span>
                    <p id="statusText" class="text-xs text-pink-700 font-medium">Verificando...</p>
                </div>
            </div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-screen overflow-hidden">
        <header class="bg-white border-b border-gray-200 px-8 py-5 flex justify-between items-center z-20 shadow-sm">
            <div>
                <h2 id="page-title" class="text-2xl font-bold text-gray-800">Tarefas Júlia Ribeiro</h2>
                <p class="text-sm text-gray-500 mt-1">Sincronizado via Cloud Firestore</p>
            </div>
            <button onclick="openModal()" class="flex items-center gap-2 bg-[#940969] text-white px-5 py-2.5 rounded-lg hover:bg-[#740652] transition-colors shadow-md">
                <i data-lucide="plus-circle" class="w-4 h-4"></i>
                <span class="hidden sm:inline font-medium">Nova Tarefa</span>
            </button>
        </header>

        <div class="flex-1 overflow-auto p-8">
            <div class="max-w-[1600px] mx-auto space-y-8">
                <!-- DASHBOARD -->
                <div id="dashboard-view" class="space-y-6 slide-up">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
                            <span class="text-gray-500 text-xs font-medium">Total</span>
                            <h3 id="card-total" class="text-2xl font-bold text-gray-800 mt-1">0</h3>
                        </div>
                        <div class="bg-white p-5 rounded-xl border border-orange-100 shadow-sm">
                            <span class="text-orange-600 text-xs font-medium">Pendentes</span>
                            <h3 id="card-pending" class="text-2xl font-bold text-gray-800 mt-1">0</h3>
                        </div>
                        <div class="bg-white p-5 rounded-xl border border-green-100 shadow-sm">
                            <span class="text-green-600 text-xs font-medium">Concluídas</span>
                            <h3 id="card-completed" class="text-2xl font-bold text-gray-800 mt-1">0</h3>
                        </div>
                        <div class="bg-white p-5 rounded-xl border border-red-100 shadow-sm">
                            <span class="text-red-600 text-xs font-medium">Urgentes P0</span>
                            <h3 id="card-urgent" class="text-2xl font-bold text-gray-800 mt-1">0</h3>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                            <h3 class="font-bold text-gray-800 mb-4">Por Município</h3>
                            <div class="h-64"><canvas id="chartMunicipality"></canvas></div>
                        </div>
                        <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                            <h3 class="font-bold text-gray-800 mb-4">Por Status</h3>
                            <div class="h-64"><canvas id="chartSystem"></canvas></div>
                        </div>
                    </div>
                </div>

                <!-- LISTA -->
                <div id="list-view" class="hidden space-y-6">
                    <div class="flex gap-4 bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
                        <div class="relative flex-1">
                            <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-4 h-4"></i>
                            <input type="text" id="searchInput" placeholder="Filtrar tarefas..." class="w-full pl-10 pr-4 py-2 border border-gray-200 rounded-lg outline-none focus:ring-2 focus:ring-[#940969]">
                        </div>
                        <select id="municipalityFilter" class="bg-gray-50 border border-gray-200 rounded-lg px-4 py-2 text-sm outline-none"></select>
                    </div>

                    <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-[#940969] text-white">
                                    <tr>
                                        <th class="px-6 py-4">Tarefa</th>
                                        <th class="px-6 py-4">Município</th>
                                        <th class="px-6 py-4 text-center">Status</th>
                                        <th class="px-6 py-4 text-right">Data Inclusão</th>
                                        <th class="px-6 py-4"></th>
                                    </tr>
                                </thead>
                                <tbody id="tableBody" class="divide-y divide-gray-100"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- MODAL -->
    <div id="modal" class="hidden fixed inset-0 bg-black/40 backdrop-blur-sm z-50 items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden">
            <div class="px-6 py-4 border-b bg-gray-50 flex justify-between items-center">
                <h3 id="modalTitle" class="font-bold text-gray-800">Tarefa</h3>
                <button onclick="closeModal()">✕</button>
            </div>
            <form id="demandForm" class="p-6 space-y-4">
                <input type="hidden" name="firestoreId" id="firestoreId">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase">Descrição da Tarefa</label>
                    <input required name="title" id="inputTitle" type="text" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-[#940969] outline-none">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase">Município</label>
                        <select id="modalMunicipality" name="requester" class="w-full px-4 py-2 border rounded-lg"></select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase">Prioridade</label>
                        <select name="priority" id="inputPriority" class="w-full px-4 py-2 border rounded-lg">
                            <option value="P0">P0 - Urgente</option>
                            <option value="P1">P1 - Alta</option>
                            <option value="P2" selected>P2 - Média</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase">Status</label>
                    <select name="status" id="inputStatus" class="w-full px-4 py-2 border rounded-lg">
                        <option value="Não iniciada">Não iniciada</option>
                        <option value="Em execução">Em execução</option>
                        <option value="Concluída">Concluída</option>
                    </select>
                </div>
                <div class="pt-4 flex justify-end gap-3">
                    <button type="button" onclick="closeModal()" class="px-4 py-2 text-gray-500">Cancelar</button>
                    <button type="submit" class="px-6 py-2 bg-[#940969] text-white rounded-lg font-bold">Salvar Dados</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB2MnM6HIIK8JqvxJiWXYWKCOq0SJc0NVU",
            authDomain: "tarefasjulia-b8007.firebaseapp.com",
            projectId: "tarefasjulia-b8007",
            storageBucket: "tarefasjulia-b8007.firebasestorage.app",
            messagingSenderId: "287504808626",
            appId: "1:287504808626:web:a98ab2e529d656cf30a7ab",
            measurementId: "G-YNRQSXDXHQ"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'producao_v1';

        let demands = [];
        let state = { searchTerm: '', filterMunicipality: 'Todos', activeTab: 'dashboard', charts: {} };
        let connectionTimeout;

        // --- MONITOR DE TIMEOUT ---
        // Se após 10 segundos não carregar, mostra ajuda
        connectionTimeout = setTimeout(() => {
            if (!document.getElementById('loading-overlay').classList.contains('hidden')) {
                showError(
                    "O sistema está demorando muito para responder. Isso geralmente acontece se o domínio do GitHub não foi autorizado no console do Firebase.",
                    "Possível problema de Domínio"
                );
            }
        }, 12000);

        // --- INICIALIZAÇÃO ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log("Autenticado com sucesso.");
                updateStatus(true, "Conectado");
                setupListener();
            } else {
                signInAnonymously(auth).catch(err => {
                    if (err.code === 'auth/unauthorized-domain') {
                        showError(
                            "Este domínio não está autorizado no Firebase. Vá em 'Authentication' > 'Settings' > 'Authorized Domains' e adicione 'enfjuliaribeiro-hash.github.io'.",
                            "Domínio não autorizado"
                        );
                    } else {
                        showError("Erro de Autenticação: " + err.message);
                    }
                });
            }
        });

        function showError(msg, title = "Erro de Conexão") {
            clearTimeout(connectionTimeout);
            document.getElementById('loader-spinner').classList.add('hidden');
            document.getElementById('loader-text').classList.add('hidden');
            document.getElementById('loader-subtext').classList.add('hidden');
            const errDiv = document.getElementById('error-container');
            errDiv.classList.remove('hidden');
            errDiv.innerHTML = `
                <div class="error-box text-left">
                    <p class="font-bold flex items-center gap-2 text-rose-700">
                        <i data-lucide="alert-circle" class="w-5 h-5"></i> ${title}
                    </p>
                    <p class="text-sm mt-3 text-rose-600">${msg}</p>
                    <div class="mt-4 p-3 bg-white/50 rounded-lg text-xs border border-rose-100">
                        <b>Dica:</b> No Firebase, vá em Authentication > Settings > Authorized Domains e adicione enfjuliaribeiro-hash.github.io
                    </div>
                </div>
                <button onclick="location.reload()" class="mt-4 px-4 py-2 bg-white border border-gray-300 rounded-lg text-sm hover:bg-gray-50 shadow-sm">Tentar novamente</button>
            `;
            lucide.createIcons();
        }

        function setupListener() {
            const q = collection(db, 'artifacts', appId, 'public', 'data', 'demands');
            
            onSnapshot(q, (snapshot) => {
                clearTimeout(connectionTimeout);
                demands = snapshot.docs.map(d => ({ ...d.data(), firestoreId: d.id }));
                demands.sort((a,b) => (parseInt(b.id?.split('-')[1]) || 0) - (parseInt(a.id?.split('-')[1]) || 0));
                
                initFilters();
                render();
                document.getElementById('loading-overlay').classList.add('hidden');
            }, (error) => {
                showError("Erro no banco de dados: " + error.message, "Permissão Negada");
            });
        }

        // --- LÓGICA DE UI ---
        async function handleSave(formData) {
            const fId = formData.get('firestoreId');
            const data = {
                title: formData.get('title'),
                requester: formData.get('requester'),
                priority: formData.get('priority'),
                status: formData.get('status'),
                inclusionDate: new Date().toISOString().split('T')[0]
            };

            const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'demands');
            try {
                if (fId) {
                    await updateDoc(doc(colRef, fId), data);
                } else {
                    let maxNum = 0;
                    demands.forEach(d => {
                        const n = parseInt(d.id?.split('-')[1]) || 0;
                        if(n > maxNum) maxNum = n;
                    });
                    data.id = `T-${String(maxNum + 1).padStart(3, '0')}`;
                    await addDoc(colRef, data);
                }
                closeModal();
            } catch (err) {
                alert("Erro ao salvar: " + err.message);
            }
        }

        window.switchTab = (tab) => {
            state.activeTab = tab;
            document.getElementById('dashboard-view').classList.toggle('hidden', tab !== 'dashboard');
            document.getElementById('list-view').classList.toggle('hidden', tab !== 'list');
            const bL = document.getElementById('btn-list');
            const bD = document.getElementById('btn-dashboard');
            bL.className = tab === 'list' ? 'w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium transition-colors bg-[#940969]/10 text-[#940969]' : 'w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-50';
            bD.className = tab === 'dashboard' ? 'w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium transition-colors bg-[#940969]/10 text-[#940969]' : 'w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-50';
            render();
        };

        function initFilters() {
            const munis = ['Todos', ...new Set(demands.map(d => d.requester || 'Geral'))].sort();
            document.getElementById('municipalityFilter').innerHTML = munis.map(m => `<option value="${m}">${m}</option>`).join('');
            document.getElementById('modalMunicipality').innerHTML = munis.filter(m => m !== 'Todos').map(m => `<option value="${m}">${m}</option>`).join('') + `<option value="Outro">Outro</option>`;
        }

        function render() {
            const filtered = demands.filter(d => {
                const search = (d.title || "").toLowerCase().includes(state.searchTerm.toLowerCase());
                const muni = state.filterMunicipality === 'Todos' || d.requester === state.filterMunicipality;
                return search && muni;
            });

            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = filtered.map(d => `
                <tr class="hover:bg-gray-50 transition-colors">
                    <td class="px-6 py-4"><span class="text-[10px] text-gray-400 font-mono block">${d.id}</span><div class="font-medium text-gray-900">${d.title}</div></td>
                    <td class="px-6 py-4 text-sm text-gray-600">${d.requester}</td>
                    <td class="px-6 py-4 text-center"><span class="px-2 py-0.5 rounded-full text-[10px] font-bold ${d.status === 'Concluída' ? 'bg-green-100 text-green-700' : 'bg-pink-100 text-pink-700'}">${d.status}</span></td>
                    <td class="px-6 py-4 text-right text-xs text-gray-400">${d.inclusionDate || '--'}</td>
                    <td class="px-6 py-4 text-right"><button onclick="editDemand('${d.firestoreId}')" class="text-[#940969] text-xs font-bold hover:underline">EDITAR</button></td>
                </tr>
            `).join('');

            document.getElementById('card-total').textContent = demands.length;
            document.getElementById('card-completed').textContent = demands.filter(d => d.status === 'Concluída').length;
            document.getElementById('card-pending').textContent = demands.filter(d => d.status === 'Não iniciada').length;
            document.getElementById('card-urgent').textContent = demands.filter(d => d.priority === 'P0' && d.status !== 'Concluída').length;

            if (state.activeTab === 'dashboard') updateCharts();
            lucide.createIcons();
        }

        window.editDemand = (fId) => {
            const d = demands.find(i => i.firestoreId === fId);
            if (!d) return;
            document.getElementById('firestoreId').value = fId;
            document.getElementById('inputTitle').value = d.title;
            document.getElementById('modalMunicipality').value = d.requester;
            document.getElementById('inputPriority').value = d.priority;
            document.getElementById('inputStatus').value = d.status;
            document.getElementById('modalTitle').textContent = `Editar ${d.id}`;
            document.getElementById('modal').classList.remove('hidden');
            document.getElementById('modal').classList.add('flex');
        };

        window.openModal = () => {
            document.getElementById('demandForm').reset();
            document.getElementById('firestoreId').value = '';
            document.getElementById('modalTitle').textContent = 'Nova Tarefa';
            document.getElementById('modal').classList.remove('hidden');
            document.getElementById('modal').classList.add('flex');
        };

        window.closeModal = () => document.getElementById('modal').classList.add('hidden');

        function updateStatus(on, text) {
            document.getElementById('statusDot').className = `w-2 h-2 rounded-full ${on ? 'bg-green-500 animate-pulse' : 'bg-red-500'}`;
            document.getElementById('statusText').textContent = text;
        }

        function updateCharts() {
            const muniData = {};
            demands.forEach(d => { if(d.requester) muniData[d.requester] = (muniData[d.requester] || 0) + 1; });
            const ctxMuni = document.getElementById('chartMunicipality');
            if(state.charts.muni) state.charts.muni.destroy();
            state.charts.muni = new Chart(ctxMuni, {
                type: 'bar',
                data: { labels: Object.keys(muniData), datasets: [{ data: Object.values(muniData), backgroundColor: '#940969', borderRadius: 6 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });

            const stats = { 'Não iniciada': 0, 'Em execução': 0, 'Concluída': 0 };
            demands.forEach(d => { if(stats[d.status] !== undefined) stats[d.status]++; });
            const ctxSys = document.getElementById('chartSystem');
            if(state.charts.sys) state.charts.sys.destroy();
            state.charts.sys = new Chart(ctxSys, {
                type: 'doughnut',
                data: { labels: Object.keys(stats), datasets: [{ data: Object.values(stats), backgroundColor: ['#f97316', '#3b82f6', '#22c55e'] }] },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        document.getElementById('searchInput').addEventListener('input', e => { state.searchTerm = e.target.value; render(); });
        document.getElementById('municipalityFilter').addEventListener('change', e => { state.filterMunicipality = e.target.value; render(); });
        document.getElementById('demandForm').addEventListener('submit', e => { e.preventDefault(); handleSave(new FormData(e.target)); });
    </script>
</body>
</html>